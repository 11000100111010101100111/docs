# 索引

索引在 TapDB 中用以支持高效查询。如果没有索引，TapDB 必须扫描集合中的每个文档才能返回查询结果；而有了适当的索引，TapDB 可以限制扫描的文档数，从而提高查询性能。虽然索引可以提升查询性能，但添加索引会影响写入操作的性能，因为每次插入操作都必须更新所有相关的索引，因此在高写入率的集合需要评估其索引更新成本。

## 用例

如果应用程序对相同字段重复运行查询，则可以为这些字段创建索引以提高性能。例如，以下是一些常见的场景及其对应的索引类型：

场景 | 索引类型
:--- | :---
人力资源部门经常通过员工 ID 查找员工信息。您可以在员工 ID 字段上创建索引以提高查询性能。 | 单字段索引
销售人员经常按位置查找客户信息，位置存储在一个嵌入式对象中，包括 state、city 和 zipcode 等字段。您可以在 location 对象上创建索引。 | 单字段索引在嵌入式文档上
杂货店经理按名称和数量查找库存商品，以确定哪些商品库存不足。您可以同时为 item 和 quantity 字段创建复合索引。 | 复合索引

:::tip

在嵌入式文档上创建索引时，仅对整个嵌入式文档的查询使用该索引。对文档中特定字段的查询不使用该索引。

:::

## 开始体验

您可以使用驱动程序方法或 TapDB Shell 创建和管理索引。

### 创建和管理索引

您可以使用驱动程序方法或 TapDB Shell 来创建和管理索引。

## 详情

索引是一种特殊的数据结构，它以易于遍历的形式存储一小部分集合数据。 TapDB 索引使用 B-Tree 数据结构。索引存储特定字段或多个字段的值，并按字段值排序。这种排序支持高效的等值匹配和基于范围的查询操作。此外，TapDB 还可以使用索引顺序来返回排序后的结果。

下图说明了使用索引来选择匹配文档并为其排序的查询：

![](../images/index-for-sort.bakedsvg.svg)

TapDB 中的索引与其他数据库系统中的索引类似，您可以在集合级别定义索引，也可以对集合中文档的任何字段或子字段建立索引。



## 默认 _id 索引

TapDB 在创建集合时会自动对 `_id` 字段创建唯一索引，该索引可防止插入两个具有相同 `_id` 字段值的文档，且不能删除此索引。

:::tip

在分片集群中，如果不使用 `_id` 字段作为分片键，应用程序必须确保 `_id` 字段中值的唯一性，以防止出错，通常可以使用自动生成的标准 ObjectId 实现。

:::

## 创建索引

要在 TapDB Shell 中创建索引，请使用 `db.collection.createIndex()` 方法。

```sql
db.collection.createIndex( <key and index type specification>, <options> )
```

以下示例在`name`字段上创建单键降序索引：

```sql
db.collection.createIndex( { name: -1 } )
```

`db.collection.createIndex()` 方法仅在相同规范的索引不存在时创建索引。

### 索引名称

索引的默认名称是索引键和索引中每个键方向（即 1 或 -1）的连接，使用下划线作为分隔符。例如，在 `{ item: 1, quantity: -1 }` 上创建的索引的名称为 `item_1_quantity_-1`。

您可以使用自定义名称创建索引，从而创建具有业务意义的索引名称。下述案例中，通过 `createIndex()` 方法在 `item` 和 `quantity` 上创建一个名为 `query for inventory` 的索引：

```sql
db.products.createIndex(
    { item: 1, quantity: -1 } ,
    { name: "query for inventory" }
)
```

您可以使用 `db.collection.getIndexes()` 方法查看索引名称，索引一旦创建就无法重命名。

## 索引类型

TapDB 提供了许多不同的索引类型来支持特定的数据和查询类型。

### 单个字段

除了 TapDB 定义的 `_id` 索引外，TapDB 还支持对文档的单个字段创建用户定义的升序/降序索引。

![](../images/index-ascending.bakedsvg.svg)

对于单字段索引和排序操作，索引键的排序顺序（即升序或降序）并不重要，因为 TapDB 可以沿任一方向遍历索引。

### 复合索引

TapDB 还支持针对多个字段的用户自定义索引，即复合索引。

复合索引中列出的字段顺序很重要。例如，复合索引 `{ userid: 1, score: -1 }` 按 `userid` 排序，然后在每个 `userid` 值中按 `score` 排序。

![](../images/index-compound-key.bakedsvg.svg)

对于复合索引和排序操作，排序顺序（即 升序或降序）可以决定索引是否可以支持排序操作。 

### 多键索引

TapDB 使用多键索引来索引存储在数组中的内容。如果对保存数组值的字段建立索引，TapDB 会为数组的每个唯一元素创建单独的索引项。多键索引允许查询通过匹配数组的一个或多个元素来选择包含数组的文档。如果索引字段包含数组值，TapDB 会自动判断是否创建多键索引，无需显式指定多键类型。

![](../images/index-multikey.bakedsvg.svg)

### 地理空间索引

TapDB 提供了两种特殊索引来支持地理空间坐标数据的高效查询：返回结果时使用平面几何的 `2d` 索引和使用球面几何返回结果的 `2dsphere` 索引。

该索引为稀疏索引。 如果要使用稀疏索引创建复合索引，请先查看使用稀疏复合索引的特殊注意事项。

### 文本搜索索引

TapDB 提供 `text` 索引类型，以支持在集合中搜索字符串内容。要了解有关文本索引的更多信息，请参阅文本索引。

该索引为稀疏索引。 如果要使用稀疏索引创建复合索引，请先查看使用稀疏复合索引的特殊注意事项。

### 哈希索引

TapDB 提供 `hashed` 索引类型，用于支持基于哈希的分片。这些索引在其范围内的值分布更随机，但仅支持等值匹配，不支持基于范围的查询。

### 聚集索引

从 TapDB 5.3 开始，您可以使用集群索引创建集合。使用集群索引创建的集合称为“集群化集合”。

### 通配符索引

从 TapDB 4.2 开始，您可以使用通配符索引支持对多个字段、任意字段或未知字段的查询。创建通配符索引时，使用 `$**` 表示所有字段或所有值，以便使用单个命令对以下任何内容进行索引：

- 字段的所有值

- 文档中的所有字段

- 文档中除特定字段路径（Field Path）之外的所有字段

- 文档中的多个特定字段

- 要了解更多信息，请参阅通配符索引。

## 索引属性

### 唯一索引

唯一索引确保 TapDB 拒绝索引字段的重复值。除唯一约束外，唯一索引在功能上与其他 TapDB 索引类似。

### 部分索引

部分索引仅对符合指定过滤表达式的文档进行索引，降低存储要求和索引创建与维护的性能成本。

部分索引提供了比稀疏索引更全面的功能，因此应优先选择部分索引。

### 稀疏索引

稀疏索引确保索引仅包含具有索引字段的文档条目，跳过没有索引字段的文档。

您可以将稀疏索引选项与唯一索引选项结合使用，以防止插入索引字段具有重复值的文档，并跳过索引缺少索引字段的文档。

### TTL 索引

TTL 索引是一种特殊索引，TapDB 可以使用它在一定时间后自动删除集合中的文档。这适用于仅需在数据库中保留有限时间的数据，如日志和会话信息。

### 隐藏索引

从 4.4 版本开始，隐藏索引对查询规划器不可见，不用于支持查询。隐藏索引允许评估删除索引的潜在影响，索引在隐藏期间保持完全维护，一旦取消隐藏即刻可用。

除`_id`索引外，您可以隐藏任何索引。

## 索引使用

索引可以提高读取操作的效率。分析查询性能教程提供了带索引和不带索引的查询执行统计信息示例。

## 索引和排序规则

排序规则允许用户为字符串比较指定特定于语言的规则，例如字母大小写和重音符号规则。要使用索引进行字符串比较，操作还必须指定相同的排序规则。否则，索引将无法支持该操作。

:::tip

由于配置了排序规则的索引是通过 ICU 排序规则键来实现排序，因此，相比未配置排序规则的索引的索引键，有排序规则感知的索引键可能会更大。

:::

例如，集合 `myColl` 在字符串字段 `category` 上具有一个索引，排序规则语言环境为 `"fr"`：

```
db.myColl.createIndex( { category: 1 }, { collation: { locale: "fr" } } )
```

以下查询操作指定了与索引相同的排序规则，因此可以使用索引：

```
db.myColl.find( { category: "cafe" } ).collation( { locale: "fr" } )
```

而以下查询操作默认使用“简易的”二进制排序器，因此无法使用索引：

```
db.myColl.find( { category: "cafe" } )
```

如果复合索引的前缀键不是字符串、数组或嵌入式文档，即使查询操作指定了与索引不同的排序规则，它仍然可以利用该复合索引来支持对其前缀键的比较。

例如，集合 `myColl` 在数值字段 `score` 和 `price` 以及字符串字段 `category` 上有一个复合索引；该索引使用排序规则语言环境 `"fr"` 创建，用于进行字符串比较：

```
db.myColl.createIndex(
    { score: 1, price: 1, category: 1 },
    { collation: { locale: "fr" } } )
```

以下操作使用 `"simple"` 二进制排序规则进行字符串比较，它们可以使用索引：

```
db.myColl.find( { score: 5 } ).sort( { price: 1 } )
db.myColl.find( { score: 5, price: { $gt: NumberDecimal( "10" ) } } ).sort( { price: 1 } )
```

以下操作使用 `"simple"` 二进制排序规则对 `category` 字段进行字符串比较，但只能利用索引的 `score: 5` 部分：

```
db.myColl.find( { score: 5, category: "cafe" } )

```

:::info

与文档键（包括嵌入式文档键）的匹配使用简单的二进制比较。这意味着类似“foo.bár”的键的查询不会匹配“foo.bar”键，无论您为 `strength` 参数设置了什么值。

:::

以下索引只支持简单的二进制比较，不支持排序规则

- 文本索引，

- 2d索引，以及

- geoHaystack索引。

## 覆盖查询

当查询条件和查询投影仅包含索引字段时，TapDB 会直接从索引返回结果，而无需扫描任何文档或将文档调入内存。 这些覆盖查询可以非常高效。

![](../images/index-for-covered-query.bakedsvg.svg)

## 索引并集

TapDB 可以使用索引的交集来完成查询。对于指定复合查询条件的查询，如果一个索引可以满足查询条件的一部分，而另一个索引可以满足查询条件的另一部分，那么 TapDB 就可以使用这两个索引的交集来完成查询。使用复合索引和使用索引交集的效率取决于具体的查询和系统。



## 限制

索引适用某些限制，例如索引键的长度或每个collection的索引数量。

## 其他注意事项

虽然索引可以提高查询性能，但索引也会带来一些操作注意事项。

在索引构建期间，应用程序可能会遇到性能下降或集合的读/写权限受限的问题。

有关索引构建过程的更多信息，请参阅填充集合上的索引构建文档，特别是复制环境中的索引构建部分。

某些驱动程序使用 `NumberLong(1)` 而不是 `1` 来指定索引顺序，生成的索引是相同的。