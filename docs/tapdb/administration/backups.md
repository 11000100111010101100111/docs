# TapDB 备份方法

## 使用 TapData（推荐）

[TapData](https://tapdata.net) 是一款面向数据服务的平台化产品，提供数据复制、数据转换、数据开发等多种能力，不仅可以满足 TapDB 副本集、分片集的全量和增量备份，更是一个以低延迟数据复制为核心优势构建的实时异构数据集成和数据服务平台。

典型用例包括数据异地灾备、数据迁移、数据入湖、构建实时数据管道及通用 ETL 处理等。

## 通过复制数据文件进行备份

### 使用 AES256-GCM 的加密存储引擎的注意事项

对于使用 AES256-GCM 加密模式的存储引擎，AES256-GCM 要求每个进程使用带有密钥的唯一计数器区块值。注意事项如下：

- **从热备份恢复**

    从 4.2 版本开始，如果从“热”备份（即 TapDB 正在运行时获取的备份）中恢复数据，TapDB 可以在启动时检测“脏”密钥，并自动更新数据库密钥以避免重复使用初始化向量（IV）。

- **从冷备份恢复**

    如果从“冷”备份（即 TapDB 未运行时获取的备份）中恢复数据，TapDB 无法在启动时检测“脏”密钥，重复使用 IV 会导致机密性和完整性保证失效。

    从 4.2 版本开始，为了避免从冷备份恢复后重复使用密钥，TapDB 添加了新的命令行选项 `--eseDatabaseKeyRollover`。使用该选项启动时，TapDB 实例会更新使用 AES256-GCM 加密配置的数据库密钥并退出。

### 使用文件系统快照进行备份

可以通过复制 TapDB 底层数据文件来创建 TapDB 部署的备份。

如果 TapDB 存储数据文件的卷支持时间点快照，您可以使用这些快照创建特定时刻的 TapDB 系统备份。文件系统快照是操作系统卷管理器的功能，而不是 TapDB 特有的功能。操作系统可以使用文件系统快照创建卷的快照，用作数据备份的基准。快照机制取决于底层存储系统。例如，在 Linux 上，Logical Volume Manager (LVM) 可以创建快照。同样，Amazon EC2 的 EBS 存储系统也支持快照。

要获得正在运行的 TapDB 进程的正确快照，必须启用日志功能，并且日志必须与其他 TapDB 数据文件位于同一逻辑卷上。如果未启用日志功能，则无法保证快照的一致性或有效性。

要获得分片集群的一致快照，必须禁用负载均衡器，并在大约相同的时间点从每个分片和配置服务器捕获快照。

### 使用 cp 或 rsync

如果存储系统不支持快照，可以使用 `cp` 或 `rsync` 等工具直接复制文件。由于复制多个文件不是原子操作，因此必须在复制文件之前停止对 TapDB 的所有写入。

通过复制底层数据生成的备份不支持副本集的时间点恢复，并且难以管理较大的分片集群。此外，这些备份更大，因为它们包括索引和重复的底层存储填充和碎片。相比之下，`tapdump` 创建的备份较小。

## 使用 tapdump

`tapdump` 从 TapDB 数据库读取数据并创建高保真 BSON 文件，而 `taprestore` 工具可以使用这些文件来填充 TapDB 数据库。`tapdump` 和 `taprestore` 是备份和恢复小型 TapDB 部署的简单而高效的工具。

`tapdump` 和 `taprestore` 针对正在运行的 TapDB 进程进行操作，并且可以直接操作底层数据文件。默认情况下，`tapdump` 不捕获本地数据库的内容。

`tapdump` 仅捕获数据库中的文档。生成的备份节省空间，但 `taprestore` 或 TapDB 必须在恢复数据后重建索引。

连接到 TapDB 实例时，`tapdump` 可能会对 TapDB 性能产生不利影响。如果数据大于系统内存，查询会将工作集挤出内存，从而导致页面错误。

在 `tapdump` 捕获输出时，应用程序可以继续修改数据。对于副本集，`tapdump` 提供 `--oplog` 选项，以在其输出的 Oplog 条目中包含 `tapdump` 操作期间出现的条目。这允许相应的 `taprestore` 操作重放捕获的 Oplog。要恢复使用 `--oplog` 创建的备份，请使用 `taprestore` 和 `--oplogReplay` 选项。

