# 连接 Oracle

Oracle Database（简称 Oracle）是甲骨文公司的一款关系数据库管理系统。Tapdata 支持将 Oracle 作为源和目标数据库构建数据管道，本文介绍如何在 Tapdata 中添加 Oracle 数据源。

## <span id="pre">准备工作</span>

[Oracle 数据源准备工作](../../../prerequisites/certified/oracle)

## 功能限制

* Oracle 作为源库时：
  * 日志解析速度约为 10,000 QPS，如增量事件高于该速率，可能导致数据处理的延迟上升，如需提升速率，推荐采用 Tapdata 的[裸日志方案](#log-miner)。
  * 裸日志功能目前不支持在 RAC-ASM 的部署架构上使用，且不支持从 DG 架构的非主节点获取裸日志。
* Oracle 作为目标库时：
  * 异构数据库间同步时，由于 Oracle 没有空字符串，会自动转换为null，因此源库的非空约束通常不适合同步到 Oracle，可在任务配置时选择忽略 not null，从而将源表的字符串类型的非空约束进行过滤。
  * Db2 的非空字段可以用`""`赋值，但相关字段向 Oracle 写入的时候，Oracle 会认为该字段是 NULL，从而导致非空字段写入失败。

## 增量数据获取方式介绍

为了提高数据变更捕获的效率，Tapdata 不仅支持使用数据库原生日志解析工具（LogMiner），还开发了直接解析数据库增量日志文件的能力，从而实现更高效的事件捕获，两者的<span id="log-miner">对比如下</span>：

| 方案               | 特点                                                         | 适用场景                                                     |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 传统 LogMiner 方案 | ●  无需额外部署组件，运维成本低<br />●  解析数据库的 redo log 获取增量变更<br />●  采集性能受数据库性能影响，通常 QPS 低于 10,000<br />●  19C RAC 版本及以上会涉及增量数据重扫，效率较低 | 适用于轻量化部署<br />对同步性能要求不高等场景               |
| Tapdata 裸日志方案 | ●  需要单独部署组件，需要一定运维成本<br />●  解析原生二进制日志，减少中转<br />●  采集性能大幅提升，可达 250,000 以上<br />●  账号权限需适当放宽 | 适用于数据变更频繁，即同步性能要求高<br />希望采集增量数据时最小化对源库影响 |

## 注意事项

* 如设置了 connect_time（自动断开超时会话），可能导致实时同步异常，可通过下述命令检查该参数的设置。
  ```sql
  SELECT resource_name, limit FROM dba_profiles WHERE profile=( SELECT profile FROM dba_users WHERE username = 'username');
  ```
* 您需要为归档日志预留足够的存储空间，可通过  `ALTER SYSTEM SET DB_RECOVERY_FILE_DEST_SIZE` 命令设置，避免存储占满影响数据库运行。
* 当采用裸日志方案采集增量数据时，如果强行终止引擎，重启裸日志采集组件时，会重新扫描目录中积攒的 fzs 文件，可能会导致进入增量缓慢，如果发生异常，您可以将相关解析日志保存提供给技术支持。
* 当采用 LogMiner 方案采集增量数据时，您需要注意：
  * 采集性能依赖源库机器性能，在自动挖掘或者 RAC 双节点的情况下，通常推荐 PGA 内存大于 16 GB， redo 大于 512MB 且小于 2 GB，如果是单节点可以适当地降低配置，同时应避免连续归档。
  * 对于未提交事务，相关数据会存放至内存，如果事物较大（包含大量 DML 事件），为避免内存溢出，Tapdata 会将其存放至[外存](../../manage-system/manage-external-storage.md)。如果停止任务或重启引擎，Tapdata 会记录最早未提交事务的 scn 号，重启任务时会从该 scn 开始重新扫描，在下游支持幂等约束的情况下，可保障数据不丢失。为避免增量信息回退过长而影响同步信息，您可以在任务配置时设置**未提交事务生命时长**，由 Tapdata 清理超过该时长的未提交事务。
  * 为提升采集性能，可在配置任务时，关闭大字段（LOB）的同步，或者业务上明确不会更新主键字段/关联键字段。
  * 当 Oracle 低于 19C 版本时，Tapdata 将采用自动采集机制，可自动查找 redo 日志，无需关注 Oracle 部署架构，可连续不间断地采集日志。为提升采集性能，推荐基于数据变更规模设定任务配置中的 fetchSize（日志积压数量）。
  * 当 Oracle 为 19C 版本时，受限于 Oracle 内部机制调整，Tapdata 将采用手动采集机制，即线上日志连续扫描+归档日志补充循环的方式。此场景下，如果是单节点部署，由于最多只会同时扫描一份 redo 日志，性能较好；如果是 RAC 部署，由于 scn 号每个线程交替增长，因此最多会扫描 `{节点数 X 2}` 份 redo日志，最少为 `{节点数 X 1}` 份 redo 日志，当 redo 日志较大时，将会降低增量数据读取性能。
    :::tip
    由于采集过程中无法感知节点是否发生归档操作，为保障事物的顺序一致，可能触发部分节点数据重新采集的机制，因此需要目标库具备幂等约束。
    :::

## 操作步骤

1. 登录 Tapdata 平台。

2. 在左侧导航栏，单击**连接管理**。

3. 在页面右侧，单击**创建**。

4. 在弹出的对话框中，搜索并选择 **Oracle**。

5. 在跳转到的页面，根据下述说明填写 Oracle 的连接信息。

   ![Oracle 连接示例](../../../images/oracle_connection_cn.png)

   * 连接信息设置
     * **连接名称**：填写具有业务意义的独有名称。
     * **连接类型**：支持将 Oracle 作为源或目标库。
     * **连接方式**：可选择通过 SID 或 Service Name 连接。
     * **数据库地址**：数据库连接地址。
     * **端口**：数据库的服务端口。
     * **SID**/**Service Name**：填写 SID 或 Service Name 信息。
     * **Schema**：Schema 名称，即一个连接对应一个 Schema，如需连接多个 Schema 则需创建多个数据连接。
     * **其他连接串参数**：额外的连接参数，默认为空。
     * **账号**：数据库的账号。
     * **密码**：数据库账号对应的密码。
     * **日志插件**：基于业务需求选择，默认为 **logMiner**，相关介绍，见[增量日志获取方式介绍](#log-miner)。
   * **<span id="advanced">高级设置</span>**
     * **加载表注释**：选择是否加载表注释信息，帮助快速识别表的业务意义。
     * **多租户模式**：如 Oracle 为多租户模式，需打开该开关并填写 PDB 信息。
     * **使用 SSL**：选择是否开启 SSL 连接数据源，可进一步提升数据安全性，开启该功能后还需要上传 SSL 证书文件并填写证书密码，相关文件已在[开启 SSL 连接](../../../prerequisites/certified/oracle#ssl)中获取。     
     * **时间类型的时区**：默认为数据库所用的时区，您也可以根据业务需求手动指定。     
     * **套接字超时时长**：设置此参数可以避免在特殊情况下无限制等待数据库返回结果，从而形成僵尸连接，单位为分钟，通常无需设置，默认值为 0 表示不设置。     
     * **包含表**：默认为**全部**，您也可以选择自定义并填写包含的表，多个表之间用英文逗号（,）分隔。     
     * **排除表**：打开该开关后，可以设定要排除的表，多个表之间用英文逗号（,）分隔。   
     * **Agent 设置**：默认为**平台自动分配**，您也可以手动指定 Agent。     
     * **模型加载频率**：数据源中模型数量大于 1 万时，Tapdata 将按照设置的时间定期刷新模型。     
     * **开启心跳表**：当连接类型选择为**源头和目标**、**源头**时，支持打开该开关，由 Tapdata 在源库中创建一个名为 **_tapdata_heartbeat_table** 的心跳表并每隔 10 秒更新一次其中的数据（数据库账号需具备相关权限），用于数据源连接与任务的健康度监测，更多介绍，见[通过心跳表监测数据同步链路](../../../best-practice/heart-beat-task.md)。     
       :::tip     
       数据源需在数据复制/开发任务引用并启动后，心跳任务任务才会启动，此时您可以再次进入该数据源的编辑页面，即可单击**查看心跳任务**。     
       :::
   
6. 单击**连接测试**，测试通过后单击**保存**。

   :::tip

   如提示连接测试失败，请根据页面提示进行修复。

   :::



## 推荐阅读

[Oracle 实时同步到 Kafka](../../../best-practice/oracle-to-kafka.md)
